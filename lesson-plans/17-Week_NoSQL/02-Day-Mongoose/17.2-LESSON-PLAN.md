# 17.2 - Intro To Mongoose

## Instructor Do: Welcome Class and Reintroduce Career Services

- 630-45 (15 min)

- Today we are going to cover mongoose, an ODM

  - type casting, validation, query building, business logic hooks and more out of the box

  - schema - rules for data

  - CRUD with mongoose

  - build relationships between collections

- Now that we are 2/3rds of the way through let's talk about career services

  - talk to Jen with questions

### Ins: 09-Stu-MongoJS-Review

- 645-705 (20 min)

- let's review mongojs

- demo the app

- they will add routes to display and edit book data

### Ins: Review

- 705-15 (10 min)

- notice that we don't need a route for root, instead we are using `express.static`

### Ins: 10-Ins-Mongoose-Schema

- 715-25 (10 min)

- SQL can be hard to write and breaks up our flow of object oriented javascript programming so we added sequelize for an ORM

- NoSQL has Object Data Modeling (ODM) and we will use one called mongoose

  - Mongoose lets you define schemas for your collections.

  - It also helps manage data relationships and enforce validations.

- start with `server.js`

- then `exampleModel.js`

- different types have different validators

  - numbers have `min` and `max`

  - strings have `enum`, `match`, `minlength` and `maxlength`

- ask: what are the benefits of mongoose? why do we want this?

  - It let's use create a schema, enforce validations and overall make it easier to interface with a Mongoose database.

### Stu: 11-Stu-Mongoose-Schema

- 725-45 (20 min)

- demo the app (add conflicting emails)

### Ins: Review

- 745-55 (10 min)

- `match` is a string validator for a regular expression

### BREAK

- 755-810 (15 min)

### Ins: 12-Ins-Custom-Methods

- 810-20 (10 min)

- we can create custom methods with mongoose for manipulating our data

- start by demo'ing app

- then `server.js`

- then `userModel.js`

### Stu: 13-Stu-Custom-Methods

- 820-35 (15 min)

- experiment with adding your own custom methods

### Ins: Review

- 835-40 (5 min)

### Ins: 14-Ins-Populate

- 840-50 (10 min)

- demo the app

- Ask students, what if we want to see the data for all of the books stored in our library. We could go back to books, but what if we want to include all of the information about our library and our books, and query that data with just one call.

  - Answer: This is where `Mongoose`'s populate method comes in. Open the `/populated` route in your browser, and go to the books property. All of the books will be there.

  ```js
  [
    {
      books: [
        {
          _id: '5cfbc820bc851f678c714b2c',
          author: 'Herman Melville',
          title: 'Moby Dick',
          __v: 0
        },
        {
          _id: '5cfbc83ebc851f678c714b2d',
          author: 'F. Scott Fitzgerald',
          title: 'The Great Gatsby',
          __v: 0
        }
      ],
      _id: '5cfbc29cfff60b62b1a9c317',
      name: 'Campus Library',
      __v: 0
    }
  ];
  ```

- How does this happen?

  - Show them the `Library.js` model, and how it has a reference to the `Book.js` model inside it's schema.

    ```js
    const mongoose = require('mongoose');

    const Schema = mongoose.Schema;

    const LibrarySchema = new Schema({
      name: {
        type: String,
        unique: true
      },
      books: [
        {
          type: Schema.Types.ObjectId,
          ref: 'Book'
        }
      ]
    });

    const Library = mongoose.model('Library', LibrarySchema);

    module.exports = Library;
    ```

  - Then show them the `index.js` file inside of the `models` folder.

    ```js
    module.exports = {
      Book: require('./Book'),
      Library: require('./Library')
    };
    ```

  - Explain that when working with multiple models, it's often useful to be able to require all of them at once, rather than individually.

  - By exporting an object containing all of our models from the `index.js` file in the models folder, we can then require this object and access all of our models inside of `server.js`.

    ```js
    const db = require('./models');
    ```

  - Point out the `populate` method being used in `server.js`.

    ```js
    app.get('/populated', (req, res) => {
      db.Library.find({})
        .populate('books')
        .then(dbLibrary => {
          res.json(dbLibrary);
        })
        .catch(err => {
          res.json(err);
        });
    });
    ```

  - Explain that here we are running `populate("books")` after finding books and before handling the result of the query in `.then`.

### Stu: Mongoose Populate

- (20 min)

- Direct students towards the next activity located in [15-Stu-Populate/Unsolved]

# Instructions

- Open `server.js` and update the `/populate` route to return `Users` populated with notes as JSON to the client.

- **Hint:** Check out the `Note.js` and `User.js` models to see how the schemas there make the populate method possible.

### Ins: Review

- (15 min)

- Open up [15-Stu-Populate/Solved/server.js].

- Ask for a volunteer to to walk you through the solution.

```js
app.get('/populateduser', (req, res) => {
  db.User.find({})
    .populate('notes')
    .then(dbUser => {
      res.json(dbUser);
    })
    .catch(err => {
      res.json(err);
    });
});
```

- Answer any clarifying questions about this activity or any other concepts covered today before wrapping up.
