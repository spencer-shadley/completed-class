# 14.3 - Getting Associated with Relations

### Ins: Sequelize Review

- 10-15 (15 min)

- today will be all back-end, you will not need to change any front-end code

- we will iteratively build an application to learn about relations in sequelize

  - app is a blog with a CMS

* Ask students what we went over in the last class.

  - What CRUD methods did we learn? Ask students to briefly try and name as many as they can.

    - `findOne`: finds a single record from a table
    - `findAll`: finds all records from a table
    - `create`: creates a new record in a table
    - `update`: updates a record or records in a table
    - `destroy`: deletes a record or records from a table

  - What does "where" do? What might we use it for?

    - It's an object we can pass in to a Sequelize query. It lets us be more specific about which records we want to target.

  - What are validations and/or flags?
    - Optional built in Sequelize helpers that let us do things like set up default values for columns, or make sure text is within a certain length before inserting it.

### Ins: Demo 12-Blog-CRUD

- 1015-25 (10 min)

- we will be building up to this

### Warm Up: 11-Post-Model

- 1025-40 (15 min)

- add a model, it won't be functional yet though

### Ins: Review

- 1040-55 (15 min)

- show `config.json`

- `post.js`

  - draw table on whiteboard and then map it to an object

  - `DataTypes.STRING` is `varchar(255)`

  - `DataTypes.TEXT` is virtually unlimited

  - Google "Sequelize Data Types" to find more

- `server.js`

  - `{force: true}`

    - drops table if it exists. Why is this helpful? Dangerous?

    - you can see the drop table in the server output

- demo the table being created when synchronize is run

  ```sql
  USE blogger;
  DROP TABLE Posts;
  ```

### Partners: 12-Blog-CRUD

- 1055-25 (25 min)

- Will be adding CRUD operations in `api-routes.js`

### Ins: Review

- 1120-35 (15 min)

- show `api-routes.js`

- talk about the flow of error validations

### Ins: Demo 15-Post-Author-Joins

- 1135-50 (15 min)

- no more categories

- added authors

  - when we first start to create a post we're redirected to `author-manager.html`

- ask: what do you think the relationship is between authors and posts?

  - one to many

  - authors have posts, posts belong to authors

- create a few authors and a few posts

  - show what the data looks like in network

    - array of posts

    - post has authorId

    - post has Author member nested

### Partners: 13-relationships

- 1150-55 (5 min)

- discuss how you would recreat the tables such that we can form a relationship between these tables

### Ins: Review

- 1155-12 (5 min)

- foreign key for author id on posts table

  - this allows multiple posts pointing to the same author

  - should be not null (every post must have an author)

## BREAK

- 12-40 (40 min)

### Ins: Introduce Sequelize Associations

- 1240-45 (5 min)

- The relationships described earlier follow:

  - Post `belongsTo` Author
  - Author `hasMany` posts

- More examples

  - Team/player

    - Player belong to team
    - team hasMany players

  - Pizza slice / Eater
    - one to one
    - pizza hasOne(eater)
    - `Team.hasOne(Game, {as: 'HomeTeam', foreignKey : 'homeTeamId'});`

### Groups Do: 14-Post-Author-Association

- 1245-105 (20 min)

### Ins: Review

- 105-25 (20 min)

- a lot of this is abstracted, we need to understand simple relationships, not complicated sequel joins

- `post.js`

  - `Post.belongsTo(models.Author)`

  - `Post` is "source" and `Author` is "target"

  - by default it will connect using primary key of target and specified foreign key

    - can override with `targetKey` option and `foreignKey`

    - https://sequelize.readthedocs.io/en/latest/docs/associations/

- `author.js`

  - what should we do when an author is removed?

    - options are RESTRICT, CASCADE, NO ACTION, SET DEFAULT, SET NULL

    - default is to set null for 1-1 and 1-many

    - default is cascade for n-m

    ```sql
      CONSTRAINT fk_name
          FOREIGN KEY (child_col1, child_col2, ... child_col_n)
          REFERENCES parent_table (parent_col1, parent_col2, ... parent_col_n)
          ON DELETE CASCADE
          [ ON UPDATE { NO ACTION | CASCADE | SET NULL | SET DEFAULT } ]
      );
    ```

### Groups Do: 14-Post-Author-Joins

- 125-40 (15 min)

# Instructions

The goal of this exercise is to modify our find queries in both post-api-routes.js and author-api-routes.js to use Sequelize's "include" option. We can use "include" to say that we want to return associated data.

1. Open the directory slacked out to you

2. Run `npm install`

3. Open the `config` directory and update the `config.json` file's `development` object to match your own local MySQL database.

4. Navigate to the `post-api-routes.js` file.

5. Add the "include" option to the queries specified in the comments. This is a feature called "eager loading". We want to "include" the Author model. Examples can be found here:
   <http://docs.sequelizejs.com/manual/tutorial/models-usage.html#eager-loading>

6. Navigate to the `author-api-routes.js` file and add the "include" option to the queries specified in the comments. Here we want to "include" the Post model.

7. If successful the application should now be fully functional. After you create a few Authors with a few posts, try navigating to either `localhost:8080/api/posts` or `localhost:8080/api/authors` to make sure the JSON returned for both routes includes all of the data.

**Hint**: The "include" key goes on the same options object as the "where" attribute we've been using. Examples can be found at the link supplied.

### Instructor: Review and Dismiss Class

- 140-2 (20 min)

- Show students how by just adding `include: [<models>]` as an option in our query we can easily get the associated data.

- Create a few quick posts and demonstrate how when we navigate to `localhost:8080/api/authors` we get all of the author data with their Posts attached. Demonstrate the same for `localhost:808/api/posts` and note how the same is true in the reverse.

- In MySQL, this is what's known as a "left outer join". We can do others with Sequelize, but this gives us very convenient access to both pieces of associated data.

removed header line- Congratulate the class on getting through one of the most challenging topics in the course.

- Encourage students to continue to review the in class exercises and to hang on to them for reference.
- Encourage students to review the [TrilogyTV Sequelize + Handlebars Review Video](https://www.youtube.com/watch?v=EDgpYNqItmc&index=1&list=PLgJ8UgkiorCnbVc-ZiCqgm3dw7Cvrewq2)
